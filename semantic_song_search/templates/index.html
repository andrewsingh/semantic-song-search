<!DOCTYPE html>
<html lang="en" data-debug-mode="{% if debug_mode %}true{% else %}false{% endif %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1280, initial-scale=0.3, user-scalable=yes">
    <title>SongMatch</title>
    <!-- CSS Modules -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header-search.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/results-songcard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/personalization.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/player.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    
    <!-- Mixpanel -->
    <script type="text/javascript">
    (function(c,a){if(!a.__SV){var b=window;try{var d,m,j,k=b.location,f=k.hash;d=function(a,b){return(m=a.match(RegExp(b+"=([^&]*)")))?m[1]:null};f&&d(f,"state")&&(j=JSON.parse(decodeURIComponent(d(f,"state"))),"mpeditor"===j.action&&(b.sessionStorage.setItem("_mpcehash",f),history.replaceState(j.desiredHash||"",c.title,k.pathname+k.search)))}catch(n){}var l,h;window.mixpanel=a;a._i=[];a.init=function(b,d,g){function c(b,i){var a=i.split(".");2==a.length&&(b=b[a[0]],i=a[1]);b[i]=function(){b.push([i].concat(Array.prototype.slice.call(arguments,0)))}}var e=a;"undefined"!==typeof g?e=a[g]=[]:g="mixpanel";e.people=e.people||[];e.toString=function(b){var a="mixpanel";"mixpanel"!==g&&(a+="."+g);b||(a+=" (stub)");return a};e.people.toString=function(){return e.toString(1)+".people (stub)"};l="disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(" ");for(h=0;h<l.length;h++)c(e,l[h]);a._i.push([b,d,g])};a.__SV=1.6;l=c.createElement("script");l.type="text/javascript";l.async=!0;l.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===c.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";h=c.getElementsByTagName("script")[0];h.parentNode.insertBefore(l,h)}})(document,window.mixpanel||[]);

    // Initialize Mixpanel with debug mode from data attribute
    var debugMode = document.documentElement.getAttribute('data-debug-mode') === 'true';
    mixpanel.init("7d28460e85f4c7776c1f29d298782de0", {
        debug: debugMode,
        track_pageview: true,
        persistence: 'localStorage'
    });
    </script>
</head>
<body>
    <div class="app-container" data-debug-mode="{% if debug_mode %}true{% else %}false{% endif %}">
        <!-- Header with Search Bar and Controls -->
        <header class="search-header">
            <div class="header-content">
                <h1 class="app-title">SongMatch</h1>

                <!-- Search Configuration Row -->
                <div class="search-config">
                    <div class="segmented-control" id="search-type-control" role="radiogroup" aria-label="Search mode selection">
                        <input type="radio" id="search-type-text" name="search-type" value="text" checked>
                        <label for="search-type-text" class="segment-label">
                            <span class="segment-icon" aria-hidden="true">üìù</span>
                            <span class="segment-text">Text-to-Song</span>
                        </label>
                        <input type="radio" id="search-type-song" name="search-type" value="song">
                        <label for="search-type-song" class="segment-label">
                            <span class="segment-icon" aria-hidden="true">üéµ</span>
                            <span class="segment-text">Song-to-Song</span>
                        </label>
                    </div>
                    
                </div>
                
                <!-- Personalization Controls (shown only when history is available) -->
                <div id="personalization-controls" class="personalization-controls" style="display: none;">
                    <div class="control-group">
                        <div class="slider-container">
                            <div class="slider-with-value">
                                <div class="slider-value-above" id="lambda-value">0.50</div>
                                <input type="range" id="lambda-slider" class="control-slider" 
                                       min="0" max="1" step="0.05" value="0.5">
                            </div>
                            <div class="slider-labels">
                                <span>Personal</span>
                                <span>Semantic</span>
                            </div>
                        </div>
                        
                        <div class="slider-container">
                            <div class="range-slider-with-values">
                                <div class="range-values-above">
                                    <div class="range-value-above" id="familiarity-min-value">0.00</div>
                                    <div class="range-value-above" id="familiarity-max-value">1.00</div>
                                </div>
                                <div class="range-slider-container">
                                    <input type="range" id="familiarity-min" class="range-slider range-slider-min" 
                                           min="0" max="1" step="0.01" value="0">
                                    <input type="range" id="familiarity-max" class="range-slider range-slider-max" 
                                           min="0" max="1" step="0.01" value="1">
                                </div>
                            </div>
                            <div class="slider-labels">
                                <span>Unfamiliar</span>
                                <span>Familiar</span>
                            </div>
                        </div>
                        
                        <button id="rerun-search-btn" class="rerun-search-btn" disabled>
                            Rerun Search
                        </button>
                    </div>
                </div>
                
                <!-- Main Search Bar -->
                <div class="search-container">
                    <input type="text" id="search-input" class="search-input" 
                           placeholder="üîç Describe the vibe and genre you're looking for... (e.g., &quot;playful summery pop&quot;, &quot;motivational workout hip hop&quot;)">
                </div>
                
                <!-- Suggestions Dropdown (for song-to-song search) -->
                <div id="suggestions" class="suggestions-container" style="display: none;"></div>
                
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Query Song Card (only for song-to-song search) -->
            <section id="query-section" class="query-section" style="display: none;">
                <h2 class="section-title">Query Song</h2>
                <div id="query-card" class="song-card query-card"></div>
            </section>
            
            <!-- Export to Playlist Accordion -->
            <section id="export-section" class="export-section" style="display: none;">
                <div class="export-accordion">
                    <button class="export-accordion-header" id="export-accordion-btn">
                        <span class="export-accordion-title">üöÄ Export Results to Playlist</span>
                        <span class="export-accordion-icon">‚ñº</span>
                    </button>
                    <div class="export-accordion-content" id="export-accordion-content">
                        <div class="export-form">
                            <div class="export-field">
                                <label for="playlist-name" class="export-label">Playlist Name:</label>
                                <input type="text" id="playlist-name" class="export-input" 
                                       placeholder="My Semantic Search Playlist">
                            </div>
                            <div id="song-count-field" class="export-field">
                                <label for="song-count" class="export-label">Number of Songs:</label>
                                <input type="number" id="song-count" class="export-input" 
                                       min="1" max="100" value="48">
                            </div>
                            <div id="manual-selection-info" class="export-field" style="display: none;">
                                <span class="export-label">Selected Songs:</span>
                                <span id="selected-songs-count" class="export-info-text">0 songs selected</span>
                            </div>
                            <button id="export-btn" class="export-button">
                                <span class="export-button-text">Create Playlist</span>
                                <span class="export-button-loading" style="display: none;">Creating...</span>
                            </button>
                        </div>
                        <div id="export-status" class="export-status" style="display: none;"></div>
                    </div>
                </div>
            </section>
            
            
            <!-- No-History Weights Section -->
            <section id="no-history-weights-section" class="no-history-weights-section" style="display: none;">
                <!-- Final Score Components Panel -->
                <div class="weights-container">
                    <div class="weights-title">
                        <h4 class="param-group-title">Final Score<br>Components</h4>
                    </div>
                    <div class="weights-inputs">
                        <div class="weight-input-group">
                            <label for="nh_a0_song_sim" class="weight-label">Song Sim:</label>
                            <input type="number" id="nh_a0_song_sim" class="weight-input" data-weight-name="a0_song_sim" step="0.05" min="0" max="1">
                        </div>
                        <div class="weight-input-group">
                            <label for="nh_a1_artist_sim" class="weight-label">Artist Sim:</label>
                            <input type="number" id="nh_a1_artist_sim" class="weight-input" data-weight-name="a1_artist_sim" step="0.05" min="0" max="1">
                        </div>
                        <div class="weight-input-group">
                            <label for="nh_a2_total_streams" class="weight-label">Total Streams:</label>
                            <input type="number" id="nh_a2_total_streams" class="weight-input" data-weight-name="a2_total_streams" step="0.05" min="0" max="1">
                        </div>
                        <div class="weight-input-group">
                            <label for="nh_a3_daily_streams" class="weight-label">Daily Streams:</label>
                            <input type="number" id="nh_a3_daily_streams" class="weight-input" data-weight-name="a3_daily_streams" step="0.05" min="0" max="1">
                        </div>
                        <div class="weight-input-group">
                            <label for="nh_a4_release_date" class="weight-label">Release Date Sim:</label>
                            <input type="number" id="nh_a4_release_date" class="weight-input" data-weight-name="a4_release_date" step="0.05" min="0" max="1">
                        </div>
                    </div>
                </div>

                <!-- Song Descriptor Weights Panel -->
                <div class="weights-container">
                    <div class="weights-title">
                        <h4 class="param-group-title">Song Descriptor<br>Weights</h4>
                    </div>
                    <div class="weights-inputs">
                        <div class="weight-input-group">
                            <label for="nh_b0_genres" class="weight-label">Genres:</label>
                            <input type="number" id="nh_b0_genres" class="weight-input" data-weight-name="b0_genres" step="0.05" min="0" max="1">
                        </div>
                        <div class="weight-input-group">
                            <label for="nh_b1_vocal_style" class="weight-label">Vocal Style:</label>
                            <input type="number" id="nh_b1_vocal_style" class="weight-input" data-weight-name="b1_vocal_style" step="0.05" min="0" max="1">
                        </div>
                        <div class="weight-input-group">
                            <label for="nh_b2_production_sound_design" class="weight-label">Production:</label>
                            <input type="number" id="nh_b2_production_sound_design" class="weight-input" data-weight-name="b2_production_sound_design" step="0.05" min="0" max="1">
                        </div>
                        <div class="weight-input-group">
                            <label for="nh_b3_lyrical_meaning" class="weight-label">Lyrics:</label>
                            <input type="number" id="nh_b3_lyrical_meaning" class="weight-input" data-weight-name="b3_lyrical_meaning" step="0.05" min="0" max="1">
                        </div>
                        <div class="weight-input-group">
                            <label for="nh_b4_mood_atmosphere" class="weight-label">Mood:</label>
                            <input type="number" id="nh_b4_mood_atmosphere" class="weight-input" data-weight-name="b4_mood_atmosphere" step="0.05" min="0" max="1">
                        </div>
                        <div class="weight-input-group">
                            <label for="nh_b5_tags" class="weight-label">Tags:</label>
                            <input type="number" id="nh_b5_tags" class="weight-input" data-weight-name="b5_tags" step="0.05" min="0" max="1">
                        </div>
                    </div>
                </div>

                <!-- Weights Buttons -->
                <div class="weights-buttons-container">
                    <button id="no-history-rerun-btn" class="rerun-search-btn" disabled>
                        <span>üîÑ Rerun Search</span>
                    </button>
                    <button id="no-history-reset-btn" class="reset-defaults-btn">
                        <span>‚Ü∫ Reset to Defaults</span>
                    </button>
                </div>
            </section>
            
            <!-- Search Results -->
            <section id="results-section" class="results-section">
                <div id="results-header" class="results-header" style="display: none;">
                    <div class="results-controls">
                        <div class="results-left">
                            <h2 class="section-title">Matching Songs</h2>
                            <div class="results-filters">
                                <div class="filter-option">
                                    <label class="filter-checkbox-label">
                                        <input type="checkbox" id="manual-selection-toggle" class="filter-checkbox">
                                        <span class="filter-text">Manual Selection</span>
                                    </label>
                                </div>
                                <div id="top-artists-filter-option" class="filter-option">
                                    <label class="filter-checkbox-label">
                                        <input type="checkbox" id="top-artists-filter" class="filter-checkbox" disabled>
                                        <span id="top-artists-text" class="filter-text">Only My Top Artists</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="results-right">
                            <!-- Personalization controls will be moved here via JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Results info moved to separate line -->
                    <div class="results-info-line">
                        <span id="results-count"></span>
                        <span id="search-info"></span>
                        <div class="results-spotify-attribution">
                            <a href="https://open.spotify.com" target="_blank" rel="noopener noreferrer" class="results-spotify-logo-link">
                                <img src="{{ url_for('static', filename='assets/2024-spotify-full-logo/Full_Logo_Green_RGB.svg') }}" 
                                     alt="Spotify" class="results-spotify-logo">
                            </a>
                        </div>
                    </div>
                </div>
                
                <div id="results-container" class="results-container">
                    <!-- Welcome message -->
                    <div id="welcome-message" class="welcome-message">
                        <div class="welcome-content">
                            <h3>Getting Started</h3>
                            
                            <h4>üîç Make a search query</h4>
                            <ul>
                                <li><strong>Text-to-Song:</strong> Search songs by describing the vibe and genre you're looking for</li>
                                <li><strong>Song-to-Song:</strong> Find songs that are similar to one that you have in mind</li>
                            </ul>
                            
                            <h4>üîß Adjust score weights and filter results</h4>
                            <ul>
                                <li><strong>Tunable weights:</strong> Adjust the score weights to prioritize different aspects of the song</li>
                                <li><strong>Playable results:</strong> Click on any song card to play the song in the built-in web player</li>
                                <li><strong>Manual selection:</strong> Enable this mode to select specific songs to include in your playlist</li>
                            </ul>
                            
                            <h4>üöÄ Export to playlist</h4>
                            <ul>
                                <li>Once you're happy with your results, click <strong>Export Results to Playlist</strong></li>
                                <li>Change the playlist name and number of songs if you'd like, then click <strong>Create Playlist</strong></li>
                                <li>Click the provided link to go to your new playlist in your Spotify library. Happy listening!</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Results will be populated here -->
                    <div id="results-grid" class="results-grid"></div>
                    
                    <!-- Load More Button -->
                    <div id="load-more-container" class="load-more-container" style="display: none;">
                        <button id="load-more-btn" class="load-more-btn">Load More Results</button>
                    </div>
                </div>
                
                <!-- Loading indicator -->
                <div id="loading" class="loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Searching for matching songs...</p>
                </div>
            </section>
        </main>

        <!-- Spotify Web Player (Fixed at Bottom) -->
        <footer class="player-footer">
            <div id="spotify-player" class="spotify-player">
                <!-- Spotify Attribution -->
                <div class="spotify-attribution">
                    <a href="https://open.spotify.com" target="_blank" rel="noopener noreferrer" class="spotify-logo-link">
                        <img src="{{ url_for('static', filename='assets/2024-spotify-full-logo/Full_Logo_Green_RGB.svg') }}" 
                             alt="Spotify" class="spotify-logo">
                    </a>
                </div>
                <!-- Player will be initialized here -->
                <div class="player-content">
                    <div class="track-info">
                        <img id="player-cover" class="player-cover" src="" alt="Album Cover">
                        <div class="track-details">
                            <div id="player-title" class="player-title">No track selected</div>
                            <div id="player-artist" class="player-artist">Click on a track card to play it</div>
                        </div>
                    </div>
                    
                    <div class="player-controls">
                        <button id="prev-btn" class="control-btn">‚èÆ</button>
                        <button id="play-btn" class="control-btn play-btn">‚ñ∂</button>
                        <button id="next-btn" class="control-btn">‚è≠</button>
                    </div>
                    
                    <div class="progress-container">
                        <span id="current-time" class="time-label">0:00</span>
                        <div class="progress-bar-container">
                            <div id="progress-bar" class="progress-bar">
                                <div id="progress-filled" class="progress-filled"></div>
                            </div>
                        </div>
                        <span id="total-time" class="time-label">0:00</span>
                    </div>
                    
                    <!-- Auth Status -->
                    <div class="auth-status">
                        <span id="auth-indicator" class="auth-indicator">‚óã</span>
                        <span id="auth-text">Not connected to Spotify</span>
                        <button id="login-btn" class="login-btn" style="display: none;">Login to Spotify</button>
                        <button id="logout-btn" class="logout-btn" style="display: none;">Logout</button>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- JavaScript Modules -->
    <script src="{{ url_for('static', filename='utils.js') }}"></script>
    <script src="{{ url_for('static', filename='spotify-player.js') }}"></script>
    <script src="{{ url_for('static', filename='playlist-export.js') }}"></script>
    <script src="{{ url_for('static', filename='search.js') }}"></script>
    <script src="{{ url_for('static', filename='personalization.js') }}"></script>
    <script src="{{ url_for('static', filename='results-ui.js') }}"></script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html> 